pipeline {
    agent any

    tools {
        git 'Default'
        jdk 'jdk17'
        maven 'maven3'
        sonar 'sonarscanner'
    }

    environment {
        SONARQUBE_ENV = 'sonarqube'
        REPO_URL = 'https://github.com/prakash-128/Book-My-Show.git'
        BRANCH = 'main'
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
                echo '‚úÖ Workspace cleaned successfully.'
            }
        }

        stage('Checkout from Git') {
            steps {
                echo 'üì¶ Cloning repository...'
                git branch: "${BRANCH}", url: "${REPO_URL}"
                sh 'ls -la'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'üîç Running SonarQube code analysis...'
                withSonarQubeEnv("${SONARQUBE_ENV}") {
                    sh '''
                        sonar-scanner \
                        -Dsonar.projectKey=BookMyShow \
                        -Dsonar.projectName=BookMyShow \
                        -Dsonar.sources=. \
                        -Dsonar.java.binaries=bookmyshow-app/target
                    '''
                }
            }
        }

        stage('Build Project') {
            steps {
                echo '‚öôÔ∏è Building the application...'
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'üß™ Running tests...'
                sh 'mvn test'
            }
        }

        stage('Quality Gate') {
            steps {
                echo 'üõ°Ô∏è Waiting for SonarQube Quality Gate result...'
                timeout(time: 2, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Deploy (Optional)') {
            when {
                branch 'main'
            }
            steps {
                echo 'üöÄ Deploying the application...'
                sh 'kubectl apply -f deployment.yml'
                sh 'kubectl apply -f service.yml'
            }
        }
    }

    post {
        always {
            echo 'üßπ Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed! Check the logs.'
        }
    }
}
